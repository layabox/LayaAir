!function(e,t){"use strict";class r{constructor(){}static init(){if(!r.lookup){r.lookup=new Uint8Array(256);for(var e=0;e<r.chars.length;e++)r.lookup[r.chars.charCodeAt(e)]=e}}static isBase64String(e){return r.reg.test(e)}static encode(e){var t,a=new Uint8Array(e),n=a.length,l="";for(t=0;t<n;t+=3)l+=r.chars[a[t]>>2],l+=r.chars[(3&a[t])<<4|a[t+1]>>4],l+=r.chars[(15&a[t+1])<<2|a[t+2]>>6],l+=r.chars[63&a[t+2]];return n%3==2?l=l.substring(0,l.length-1)+"=":n%3==1&&(l=l.substring(0,l.length-2)+"=="),l}static decode(e){r.init();var t,a,n,l,s,o=.75*e.length,i=e.length,u=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var c=new ArrayBuffer(o),g=new Uint8Array(c);for(t=0;t<i;t+=4)a=r.lookup[e.charCodeAt(t)],n=r.lookup[e.charCodeAt(t+1)],l=r.lookup[e.charCodeAt(t+2)],s=r.lookup[e.charCodeAt(t+3)],g[u++]=a<<2|n>>4,g[u++]=(15&n)<<4|l>>2,g[u++]=(3&l)<<6|63&s;return c}}r.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,r.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,r.lookup=null;class a{static PixelArrayToBase64(e,r,a){let n=new Uint8ClampedArray(e),l=new ImageData(n,r,a),s=new t.HTMLCanvas(!0),o=s.source.getContext("2d");return s.source.width=r,s.source.height=a,o.putImageData(l,0,0),s.source.toDataURL()}static GenerateTexture2DWithPixel(e,r,a,n,l){let s=new t.Texture2D(r,a,n,l,!0);if(s.setPixels(e),l){let e=t.LayaGL.instance;t.WebGLContext.bindTexture(e,s._glTextureType,s._glTexture),e.generateMipmap(s._glTextureType),t.WebGLContext.bindTexture(e,s._glTextureType,null)}return s}static glTFOcclusionTrans(e){let r=e.getPixels(),n=new Uint8Array(r.length),l=r.length/4;for(let e=0;e<l;e++){let t=4*e,a=r[t+0];n[t+1]=a}return a.GenerateTexture2DWithPixel(n,e.width,e.height,t.TextureFormat.R8G8B8A8,e.mipmap)}static glTFMetallicGlossTrans(e,r,n){let l=e.getPixels(),s=new Uint8Array(l.length),o=e.width*e.height;for(let e=0;e<o;e++){let t=4*e,a=l[t+2]*r,o=255-l[t+1]*n;s[t+0]=a,s[t+3]=o}return a.GenerateTexture2DWithPixel(s,e.width,e.height,t.TextureFormat.R8G8B8A8,e.mipmap)}}class n{constructor(){}}class l{constructor(){}}class s{static _parse(e,r=null,a=null){if(s._initData(e),!s._checkglTFVersion(this._glTF.asset))return console.warn("glTF version wrong!"),new t.Sprite3D;s._initBufferData(e.buffers),s._initTextureData(e.images),s._loadMaterials(e.materials),s._loadNodes(e.nodes),s.buildHierarchy(e.nodes),s._loadScenes(e.scenes),s._loadAnimations(e.animations);let n=null!=e.scene?e.scene:0,l=s._glTFScenes[n];return s._clearData(),l}static _initData(e){s._glTF=e,e.buffers&&(s._glTFBuffers.length=e.buffers.length),e.textures&&(s._glTFTextures.length=e.textures.length),e.materials&&(s._glTFMaterials.length=e.materials.length),e.nodes&&(s._glTFNodes.length=e.nodes.length),e.scenes&&(s._glTFScenes.length=e.scenes.length)}static _clearData(){s._glTF=null,s._glTFBuffers.length=0,s._glTFTextures.length=0,s._glTFMaterials.length=0,s._glTFNodes.length=0,s._glTFScenes.length=0,s.NAMEID=0}static _checkglTFVersion(e){return"2.0"===e.version}static RegisterExtra(e,t,r){(s.Extras[e]||(s.Extras[e]={}))[t]=r}static UnRegisterExtra(e,t,r=!0){let a=s.Extras[e]||(s.Extras[e]={});if(r){let e=a[t];e&&e.recover()}delete a[t]}static ExecuteExtras(e,t,r,a){let n=s.Extras[e],l=null;if(n)for(const e in t){let t=n[e];l=t?t.runWith([...a,r]):l}return l=l||r.runWith(a),r.recover(),l}static getNodeRandomName(e){return`${e}_${s.NAMEID++}`}static _initBufferData(e){e&&e.forEach((e,r)=>{s._glTFBuffers[r]=t.Loader.getRes(e.uri)})}static getAccessorComponentsNum(e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 0}}static getAttributeNum(e){switch(e){case"POSITION":case"NORMAL":return 3;case"COLOR":return 4;case"UV":case"UV1":return 2;case"BLENDWEIGHT":case"BLENDINDICES":case"TANGENT":return 4;default:return 0}}static _getTypedArrayConstructor(e){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array}}static getBufferwithAccessorIndex(e){let t=s._glTF.accessors[e];if(!t)return null;let r=s._glTF.bufferViews[t.bufferView],a=s._glTFBuffers[r.buffer],n=t.count,l=s.getAccessorComponentsNum(t.type),o=(r.byteOffset||0)+(t.byteOffset||0),i=n*l;return new(s._getTypedArrayConstructor(t.componentType))(a,o,i)}static _initTextureData(e){e&&e.forEach((e,r)=>{s._glTFTextures[r]=t.Loader.getRes(e.uri)})}static getTextureMipmap(e){return!e||(9729===e.minFilter||9728===e.minFilter)}static getTextureFormat(e){return"image/png"===e.mimeType?1:0}static getTextureFilterMode(e){return e?9728===e.magFilter?0:s.getTextureMipmap(e)&&9987===e.minFilter?2:1:1}static getTextureWrapMode(e){return 33071===e?1:0}static getTextureConstructParams(e,t){let r=[];return r[0]=0,r[1]=0,r[2]=s.getTextureFormat(e),r[3]=s.getTextureMipmap(t),r[4]=!0,r}static getTexturePropertyParams(e){let t={};return e?(t.filterMode=s.getTextureFilterMode(e),t.wrapModeU=s.getTextureWrapMode(e.wrapS),t.wrapModeV=s.getTextureWrapMode(e.wrapT),t.anisoLevel=16,t):null}static getTexturewithInfo(e){e.texCoord&&console.warn("glTF Loader: non 0 uv channel unsupported.");let t=s._glTF.textures[e.index];return s._glTFTextures[t.source]}static _loadMaterials(e){e&&e.forEach((e,t)=>{s._glTFMaterials[t]=s._loadMaterial(e)})}static _loadMaterial(e){if(e.extras){let r=t.Handler.create(this,s._createdefaultMaterial,null,!1);return s.ExecuteExtras("MATERIAL",e.extras,r,[e])}return s._createdefaultMaterial(e)}static _createdefaultMaterial(e){let r=new t.PBRStandardMaterial;if(r.name=e.name?e.name:"",e.pbrMetallicRoughness&&s.applyPBRMetallicRoughness(e.pbrMetallicRoughness,r),e.normalTexture&&(r.normalTexture=s.getTexturewithInfo(e.normalTexture),null!=e.normalTexture.scale&&(r.normalTextureScale=e.normalTexture.scale)),e.occlusionTexture){let t=s.getTexturewithInfo(e.occlusionTexture);r.occlusionTexture=a.glTFOcclusionTrans(t),null!=e.occlusionTexture.strength&&(r.occlusionTextureStrength=e.occlusionTexture.strength)}switch(e.emissiveTexture&&(r.emissionTexture=s.getTexturewithInfo(e.emissiveTexture),r.emissionTexture&&(r.enableEmission=!0)),e.emissiveFactor&&(r.emissionColor.fromArray(e.emissiveFactor),r.emissionColor.w=1,r.enableEmission=!0),e.alphaMode||"OPAQUE"){case"OPAQUE":r.renderMode=t.PBRRenderMode.Opaque;break;case"BLEND":r.renderMode=t.PBRRenderMode.Transparent;break;case"MASK":r.renderMode=t.PBRRenderMode.Cutout}return null!=e.alphaCutoff&&(r.alphaTestValue=e.alphaCutoff),e.doubleSided&&(r.cull=t.RenderState.CULL_NONE),r}static applyPBRMetallicRoughness(e,t){e.baseColorFactor&&t.albedoColor.fromArray(e.baseColorFactor),e.baseColorTexture&&(t.albedoTexture=s.getTexturewithInfo(e.baseColorTexture));let r=t.metallic=1;null!=e.metallicFactor&&(r=t.metallic=e.metallicFactor);let n=1;if(t.smoothness=0,null!=e.roughnessFactor&&(n=e.roughnessFactor,t.smoothness=1-e.roughnessFactor),e.metallicRoughnessTexture){let l=s.getTexturewithInfo(e.metallicRoughnessTexture);t.metallicGlossTexture=a.glTFMetallicGlossTrans(l,r,n)}}static pickMeshMaterials(e){let r=[];return e.primitives.forEach(e=>{if(null!=e.material){let t=s._glTFMaterials[e.material];r.push(t)}else{let a=new t.PBRStandardMaterial;r.push(a),s._glTFMaterials.push(a),e.material=s._glTFMaterials.indexOf(a)}}),r}static _loadScenes(e){e&&e.forEach((e,t)=>{s._glTFScenes[t]=s._loadScene(e)})}static _loadScene(e){return s._createSceneNode(e)}static _createSceneNode(e){let r=new t.Sprite3D(e.name||"glTF_Scene_node");return e.nodes.forEach(e=>{let t=s._glTFNodes[e];r.addChild(t)}),r}static applyTransform(e,t){if(e.matrix){let r=t.transform.localMatrix;r.elements.set(e.matrix),t.transform.localMatrix=r}else{let r=t.transform.localPosition,a=t.transform.localRotation,n=t.transform.localScale;e.translation&&r.fromArray(e.translation),e.rotation&&a.fromArray(e.rotation),e.scale&&n.fromArray(e.scale),t.transform.localPosition=r,t.transform.localRotation=a,t.transform.localScale=n}}static buildHierarchy(e){e.forEach((e,t)=>{let r=s._glTFNodes[t];e.children&&e.children.forEach(e=>{let t=s._glTFNodes[e];r.addChild(t)})}),e.forEach((e,r)=>{let a=s._glTFNodes[r];a instanceof t.SkinnedMeshSprite3D&&s.fixSkinnedSprite(e,a)})}static _loadNodes(e){e&&(e.forEach((e,t)=>{e.name=e.name||s.getNodeRandomName("node")}),e.forEach((e,t)=>{s._glTFNodes[t]=s._loadNode(e)}))}static _loadNode(e){return s._createSprite3D(e)}static _createSprite3D(e){if(e.name=e.name,null!=e.skin){let t=s._createSkinnedMeshSprite3D(e);return s.applyTransform(e,t),t}if(null!=e.mesh){let t=s._createMeshSprite3D(e);return s.applyTransform(e,t),t}{let r=new t.Sprite3D(e.name);return s.applyTransform(e,r),r}}static _createMeshSprite3D(e){let r=s._glTF.meshes[e.mesh],a=s._loadMesh(r),n=s.pickMeshMaterials(r),l=new t.MeshSprite3D(a,e.name);return l.meshRenderer.sharedMaterials=n,l}static _createSkinnedMeshSprite3D(e){let r=s._glTF.meshes[e.mesh],a=s._glTF.skins[e.skin],n=s._loadMesh(r,a),l=s.pickMeshMaterials(r),o=new t.SkinnedMeshSprite3D(n,e.name);return o.skinnedMeshRenderer.sharedMaterials=l,o}static getArrributeBuffer(e,t,r,a){let n=s.getBufferwithAccessorIndex(e);if(!n)return null;a.push(t);let l=n;return r.set(t,l),l}static getIndexBuffer(e,t){let r=s.getBufferwithAccessorIndex(e);if(r)return new Uint32Array(r).reverse();{let e=new Uint32Array(t);for(let r=0;r<t;r++)e[r]=r;return e}}static parseMeshwithSubMeshData(e,r){let a=0,n=0,l=void 0;e.forEach(e=>{a+=e.vertexCount,n+=e.indices.length,l=l||e.vertexDecler});let o,i=t.VertexMesh.getVertexDeclaration(l,!1),u=i.vertexStride/4,c=new Float32Array(u*a),g=t.IndexFormat.UInt32;a<65536?(o=new Uint16Array(n),g=t.IndexFormat.UInt16):o=new Uint32Array(n),s.fillMeshBuffers(e,c,o,u),s.generatMesh(c,o,i,g,e,r)}static fillMeshBuffers(e,t,r,a){let n=0,l=0,s=0;e.forEach(e=>{let o=n,i=e.vertexCount,u=e.indices;for(let e=0;e<u.length;e++)r[o+e]=u[e]+l;n+=u.length,l+=i;const fillAttributeBuffer=(e,r,n=0)=>{let l=s+r;for(let r=0;r<i;r++)for(let s=0;s<n;s++)t[l+r*a+s]=e[r*n+s]};let c=0,g=e.attributeMap,f=g.get("POSITION");f&&(fillAttributeBuffer(f,c,3),c+=3);let d=g.get("NORMAL");d&&(fillAttributeBuffer(d,c,3),c+=3);let h=g.get("COLOR");h&&(fillAttributeBuffer(h,c,4),c+=4);let T=g.get("UV");T&&(fillAttributeBuffer(T,c,2),c+=2);let _=g.get("UV1");_&&(fillAttributeBuffer(_,c,2),c+=2);let m=g.get("BLENDWEIGHT");m&&(fillAttributeBuffer(m,c,4),c+=4);let x=g.get("BLENDINDICES");if(x){let e=new Uint8Array(x);fillAttributeBuffer(new Float32Array(e.buffer),c,1),c+=1}let p=g.get("TANGENT");p&&(fillAttributeBuffer(p,c,4),c+=4),s+=i*a})}static splitSubMeshByBonesCount(e,t,r,a,n){let l=s.maxSubBoneCount,o=0,i=new Set,u=e.get("BLENDINDICES"),c=u.length/4,g=new Float32Array(u.length),f=new Array(c).fill(!1);for(let e=0,s=t.length;e<s;e+=3){let c=new Set;for(let r=e;r<e+3;r++){let e=4*t[r];for(let t=0;t<4;t++)c.add(u[e+t])}let g=new Set([...i,...c]);if(g.size>l){let t=e-o;a.push(o),n.push(t);let l=Array.from(i);r.push(new Uint16Array(l)),o=e,i=new Set(c)}else i=g;if(e==s-3){let t=e-o+3;a.push(o),n.push(t),o=e;let l=Array.from(i);r.push(new Uint16Array(l))}}let d=r.length,h=new Map;e.forEach((e,t)=>{let r=new Array;h.set(t,r)});let T=c-1;for(let l=0;l<d;l++){let o=a[l],i=n[l],d=r[l],_=new Array(c).fill(!1),m=new Map;for(let r=0;r<i;r++){let a=t[r+o],n=4*a;for(let e=n;e<n+4;e++){let t=u[e],r=d.indexOf(t);r=-1==r?0:r,f[a]&&!_[a]?h.get("BLENDINDICES").push(r):f[a]&&_[a]||(g[e]=r)}f[a]||_[a]?!f[a]&&_[a]?t[r+o]=m.get(a):f[a]&&!_[a]?(_[a]=!0,T++,m.set(a,T),t[r+o]=T,h.forEach((t,r)=>{let n=s.getAttributeNum(r),l=e.get(r);if("BLENDINDICES"!==r)for(let e=0;e<n;e++)t.push(l[e+a*n])})):f[a]&&_[a]&&(t[r+o]=m.get(a)):(_[a]=!0,m.set(a,a))}_.forEach((e,t)=>{f[t]=e||f[t]})}h.forEach((t,r)=>{let a=e.get(r);"BLENDINDICES"==r&&(a=g);let n=a.length+t.length,l=new Float32Array(n);l.set(a,0),l.set(t,a.length),e.set(r,l)}),u=null}static generatMesh(e,r,a,n,l,s){let o=t.LayaGL.instance,i=new t.VertexBuffer3D(e.byteLength,o.STATIC_DRAW,!0);i.vertexDeclaration=a,i.setData(e.buffer);let u=new t.IndexBuffer3D(n,r.length,o.STATIC_DRAW,!0);u.setData(r),s._indexFormat=n,s._indexBuffer=u,s._vertexBuffer=i,s._setBuffer(i,u),s._vertexCount=i._byteLength/a.vertexStride;let c=0,g=l.length,f=new Array(g);for(let e=0;e<g;e++){let r=l[e],a=new t.SubMesh(s);f[e]=a,a._vertexBuffer=i,a._indexBuffer=u;let o=c;c+=r.indices.length;let g=r.indices.length;a._setIndexRange(o,g,n),a._boneIndicesList=r.boneIndicesList,a._subIndexBufferStart=r.subIndexStartArray,a._subIndexBufferCount=r.subIndexCountArray;for(let e=0;e<a._subIndexBufferStart.length;e++)a._subIndexBufferStart[e]+=o}s._setSubMeshes(f),s.calculateBounds();let d=i._byteLength+u._byteLength;s._setCPUMemory(d),s._setGPUMemory(d)}static applyglTFSkinData(e,r,a){if(!a)return;let n=a.joints,l=new Float32Array(s.getBufferwithAccessorIndex(a.inverseBindMatrices)),o=n.length,i=e._boneNames=[];n.forEach(e=>{let t=s._glTF.nodes[e];i.push(t.name)}),e._inverseBindPoses=[],e._inverseBindPosesBuffer=l.buffer,e._setInstanceBuffer(t.Mesh.MESH_INSTANCEBUFFER_TYPE_NORMAL);for(let r=0;r<o;r++){let a=16*r,n=l.slice(a,a+16);e._inverseBindPoses[r]=new t.Matrix4x4(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15],n)}let u=r.length,c=e._skinnedMatrixCaches;c.length=e._inverseBindPoses.length;for(let r=0;r<u;r++){let a=e.getSubMesh(r),n=a._subIndexBufferStart.length;for(let e=0;e<n;e++){let n=a._boneIndicesList[e];for(let a=0;a<n.length;a++){let l=n[a];c[l]||(c[l]=new t.skinnedMatrixCache(r,e,a))}}}for(let e=0;e<c.length;e++)c[e]||(c[e]=new t.skinnedMatrixCache(0,0,0))}static _loadMesh(e,r){if(e.extras){let a=t.Handler.create(this,s._createMesh,null,!1);return s.ExecuteExtras("MESH",e.extras,a,[e,r])}return s._createMesh(e,r)}static _createMesh(e,r){let a=new t.Mesh,l=e.primitives,o=e.weights,i=r?r.joints.length:0,u=[];return l.forEach(e=>{let t=e.mode;null==t&&(t=4),4!=t&&console.warn("glTF Loader: only support gl.TRIANGLES.");let a=[],l=new Map,c=e.attributes,g=s.getArrributeBuffer(c.POSITION,"POSITION",l,a),f=s.getArrributeBuffer(c.NORMAL,"NORMAL",l,a),d=(s.getArrributeBuffer(c.COLOR_0,"COLOR",l,a),s.getArrributeBuffer(c.TEXCOORD_0,"UV",l,a),s.getArrributeBuffer(c.TEXCOORD_1,"UV1",l,a),s.getArrributeBuffer(c.WEIGHTS_0,"BLENDWEIGHT",l,a),s.getArrributeBuffer(c.JOINTS_0,"BLENDINDICES",l,a),s.getArrributeBuffer(c.TANGENT,"TANGENT",l,a)),h=e.targets;h&&h.forEach((e,t)=>{let r=o[t],a=s.getBufferwithAccessorIndex(e.POSITION),n=s.getBufferwithAccessorIndex(e.NORMAL),l=s.getBufferwithAccessorIndex(e.TANGENT);a&&a.forEach((e,t)=>{g[t]+=e*r}),n&&n.forEach((e,t)=>{f[t]+=e*r}),l&&l.forEach((e,t)=>{d[t]+=e*r})});let T=g.length/3,_=s.getIndexBuffer(e.indices,T),m=new Array,x=[],p=[];if(r)if(i>s.maxSubBoneCount)s.splitSubMeshByBonesCount(l,_,m,x,p),T=l.get("POSITION").length/3;else{x[0]=0,p[0]=_.length,m[0]=new Uint16Array(i);for(let e=0;e<i;e++)m[0][e]=e}else x[0]=0,p[0]=_.length;let A=a.toString(),M=new n;u.push(M),M.attributeMap=l,M.indices=_,M.vertexCount=T,M.vertexDecler=A,M.boneIndicesList=m,M.subIndexStartArray=x,M.subIndexCountArray=p}),s.parseMeshwithSubMeshData(u,a),s.applyglTFSkinData(a,u,r),a}static calSkinnedSpriteLocalBounds(e){let r=e.skinnedMeshRenderer,a=e.meshFilter.sharedMesh,n=r.rootBone.transform.worldMatrix,l=new t.Matrix4x4;n.invert(l);let s=a.getIndices(),o=[],i=[],u=[];a.getPositions(o),a.getBoneIndices(i),a.getBoneWeights(u);let c=[];a._subMeshes.forEach((e,r)=>{e._boneIndicesList.forEach((r,a)=>{let n=e._subIndexBufferStart[a],l=e._subIndexBufferCount[a]+n;for(let e=n;e<l;e++){let a=s[e],n=i[a],l=r[n.x],o=r[n.y],u=r[n.z],g=r[n.w];c[a]=new t.Vector4(l,o,u,g)}})});let g=a._inverseBindPoses,f=r.bones,d=[],h=new t.Matrix4x4;f.forEach((e,r)=>{d[r]=new t.Matrix4x4,t.Matrix4x4.multiply(l,e.transform.worldMatrix,h),t.Matrix4x4.multiply(h,g[r],d[r])});let T=new t.Matrix4x4,_=new t.Vector3,m=new t.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),x=new t.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);o.forEach((e,r)=>{let a=c[r],n=u[r];for(let e=0;e<16;e++)T.elements[e]=d[a.x].elements[e]*n.x,T.elements[e]+=d[a.y].elements[e]*n.y,T.elements[e]+=d[a.z].elements[e]*n.z,T.elements[e]+=d[a.w].elements[e]*n.w;t.Vector3.transformV3ToV3(e,T,_),t.Vector3.min(m,_,m),t.Vector3.max(x,_,x)}),o=null,i=u=c=null,s=null,d=null,r.localBounds.setMin(m),r.localBounds.setMax(x)}static fixSkinnedSprite(e,t){let r=s._glTF.skins[e.skin],a=t.skinnedMeshRenderer;r.joints.forEach(e=>{let t=s._glTFNodes[e];a.bones.push(t)}),null==r.skeleton&&(r.skeleton=r.joints[0]),a.rootBone=s._glTFNodes[r.skeleton],s.calSkinnedSpriteLocalBounds(t)}static getAnimationRoot(e){const isContainNode=(e,t)=>{if(!e)return!1;if(-1==e.indexOf(t))for(let r=0;r<e.length;r++){let a=s._glTF.nodes[e[r]];if(isContainNode(a.children,t))return!0}return!0};let t=e[0].target.node;for(let e=0;e<s._glTF.scenes.length;e++){let r=s._glTF.scenes[e];if(isContainNode(r.nodes,t))return s._glTFScenes[e]}return null}static getAnimationPath(e,t){let r=[];if(e==t)return r;let a=t;for(;a.parent!=e;)a=a.parent,r.push(a.name);return r=r.reverse(),r.push(t.name),r}static _loadAnimations(e){e&&e.forEach((e,t)=>{s._loadAnimation(e)})}static _loadAnimation(e){return s._createAnimator(e)}static _createAnimator(e){let r=new t.Animator,a=e.channels,n=e.samplers,o=s.getAnimationRoot(a);if(!o)return r;o.addComponentIntance(r);let i=0,u=new Array(a.length);a.forEach((e,t)=>{let r=e.target,a=n[e.sampler],c=u[t]=new l,g=s._glTFNodes[r.node],f=s.getBufferwithAccessorIndex(a.input),d=s.getBufferwithAccessorIndex(a.output);switch(c.timeArray=new Float32Array(f),c.valueArray=new Float32Array(d),c.paths=s.getAnimationPath(o,g),c.propertyOwner="transform",c.propertyLength=1,c.propertise=[],r.path){case"translation":c.propertise.push("localPosition"),c.type=1;break;case"rotation":c.propertise.push("localRotation"),c.type=2;break;case"scale":c.propertise.push("localScale"),c.type=3}c.duration=c.timeArray[c.timeArray.length-1],i=Math.max(i,c.duration)});let c=e.name?e.name:"Aniamtor",g=new t.AnimatorControllerLayer(c),f=new t.AnimationClip;f.name="clip name",f._duration=i,f.islooping=!0,f._frameRate=30;let d=u.length,h=f._nodes;h.count=d;let T=f._nodesMap={},_=f._nodesDic={};for(let e=0;e<d;e++){let r=new t.KeyframeNode,a=u[e];h.setNodeByIndex(e,r),r._indexInList=e;let n=r.type=a.type,l=a.paths.length;r._setOwnerPathCount(l);let s=a.paths;for(let e=0;e<l;e++)r._setOwnerPathByIndex(e,s[e]);let o=r._joinOwnerPath("/"),i=T[o];i||(T[o]=i=[]),i.push(r),r.propertyOwner=a.propertyOwner;let c=a.propertyLength;r._setPropertyCount(c);for(let e=0;e<c;e++)r._setPropertyByIndex(e,a.propertise[e]);let g=o+"."+r.propertyOwner+"."+r._joinProperty(".");_[g]=g,r.fullPath=g;let f=a.timeArray.length;for(let e=0;e<f;e++)switch(n){case 0:break;case 1:case 3:case 4:let n=new t.Vector3Keyframe;r._setKeyframeByIndex(e,n);n.time=a.timeArray[e];let l=n.inTangent,s=n.outTangent,o=n.value;l.setValue(0,0,0),s.setValue(0,0,0),o.setValue(a.valueArray[3*e],a.valueArray[3*e+1],a.valueArray[3*e+2]);break;case 2:let i=new t.QuaternionKeyframe;r._setKeyframeByIndex(e,i);i.time=a.timeArray[e];let u=i.inTangent,c=i.outTangent,g=i.value;u.setValue(0,0,0,0),c.setValue(0,0,0,0),g.x=a.valueArray[4*e],g.y=a.valueArray[4*e+1],g.z=a.valueArray[4*e+2],g.w=a.valueArray[4*e+3]}}let m=new t.AnimatorState;return m.name="state name",m.clip=f,g.addState(m),g.defaultState=m,g.playOnWake=!0,r.addControllerLayer(g),g.defaultWeight=1,r}}s.NAMEID=0,s.maxSubBoneCount=24,s.Extensions={},s.Extras={},s._glTFBuffers=[],s._glTFTextures=[],s._glTFMaterials=[],s._glTFNodes=[],s._glTFScenes=[];class o{static init(){t.LoaderManager.createMap.gltf=[o.GLTF,s._parse];let e=t.Loader.parserMap;e[o.GLTF]=o._loadglTF,e[o.GLTFBASE64TEX]=o._loadBase64Texture,o._innerBufferLoaderManager.on(t.Event.ERROR,null,o._eventLoadManagerError),o._innerTextureLoaderManager.on(t.Event.ERROR,null,o._eventLoadManagerError)}static _loadglTF(e){e._originType=e.type,e.on(t.Event.LOADED,null,o._onglTFLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}static _loadBase64Texture(e){let r=e.url;e.on(t.Event.LOADED,null,(function(r){e._cache=e._createCache;let a=t.Texture2D._parse(r,e._propertyParams,e._constructParams);o._endLoad(e,a)})),e.load(r,"nativeimage",!1,null,!0)}static formatRelativePath(e,t){let r;if(r=e+t,"."===t.charAt(0)){let e=r.split("/");for(let t=0,r=e.length;t<r;t++)if(".."==e[t]){let r=t-1;r>0&&".."!==e[r]&&(e.splice(r,2),t-=2)}r=e.join("/")}return r}static _addglTFInnerUrls(e,t,r,a,n,l,s=null,i=null){let u=o.formatRelativePath(a,n);return r&&(u+=r),e.push({url:u,type:l,constructParams:s,propertyParams:i}),t&&t.push(u),u}static _getglTFInnerUrlsCount(e){let t=0;return e.buffers&&e.buffers.forEach(e=>{r.isBase64String(e.uri)||t++}),e.textures&&(t+=e.textures.length),t}static _getglTFBufferUrls(e,a,n,l){e.buffers&&e.buffers.forEach(e=>{if(r.isBase64String(e.uri)){let a=r.decode(e.uri.replace(r.reghead,""));t.Loader.cacheRes(e.uri,a)}else e.uri=o._addglTFInnerUrls(a,null,n,l,e.uri,t.Loader.BUFFER)})}static _getglTFTextureUrls(e,a,n,l,i){e.textures&&e.textures.forEach(u=>{let c=e.images[u.source],g=e.samplers?e.samplers[u.sampler]:void 0,f=s.getTextureConstructParams(c,g),d=s.getTexturePropertyParams(g);if(null!=c.bufferView||null!=c.bufferView){let s=e.bufferViews[c.bufferView],i=e.buffers[s.buffer],u=t.Loader.getRes(i.uri),g=s.byteOffset||0,h=s.byteLength,T=u.slice(g,g+h),_=r.encode(T),m=`data:${c.mimeType};base64,${_}`;c.uri=o._addglTFInnerUrls(a,n,l,"",m,o.GLTFBASE64TEX,f,d)}else r.isBase64String(c.uri)?c.uri=o._addglTFInnerUrls(a,n,l,"",c.uri,o.GLTFBASE64TEX,f,d):c.uri=o._addglTFInnerUrls(a,n,l,i,c.uri,t.Loader.TEXTURE2D,f,d)})}static _onglTFLoaded(e,r){let a=e.url,n=t.Utils3D.getURLVerion(a),l=t.URL.getPath(a),s=[];o._getglTFBufferUrls(r,s,n,l);let i=o._getglTFInnerUrlsCount(r),u=i+1,c=1/u;o._onProcessChange(e,0,c,1);let g=i/u;if(s.length>0){let a=t.Handler.create(null,o._onProcessChange,[e,c,g],!1);o._innerBufferLoaderManager._create(s,!1,t.Handler.create(null,o._onglTFBufferResourceLoaded,[e,a,r,n,l,c+g*s.length,g]),a,null,null,null,1,!0)}else o._onglTFBufferResourceLoaded(e,null,r,n,l,c,g)}static _onglTFBufferResourceLoaded(e,r,a,n,l,s,i){r&&r.recover();let u=[],c=[];if(o._getglTFTextureUrls(a,u,c,n,l),u.length>0){let n=t.Handler.create(null,o._onProcessChange,[e,s,i],!1);o._innerTextureLoaderManager._create(u,!1,t.Handler.create(null,o._onglTFTextureResourceLoaded,[e,n,a,c]),r,null,null,null,1,!0)}else o._onglTFTextureResourceLoaded(e,r,a,c)}static _onglTFTextureResourceLoaded(e,t,r,a){t&&t.recover(),e._cache=e._createCache;let n=s._parse(r,e._propertyParams,e._constructParams);o._endLoad(e,n,a)}static _eventLoadManagerError(e){t.Laya.loader.event(t.Event.ERROR,e)}static _onProcessChange(e,r,a,n){(n=r+n*a)<1&&e.event(t.Event.PROGRESS,2*n/3+1/3)}static _endLoad(e,r=null,a=null){if(a)for(let e=0;e<a.length;e++){let r=t.Loader.getRes(a[e]);r&&r._removeReference()}e.endLoad(r)}}o.GLTF="GLTF",o.GLTFBASE64TEX="GLTFBASE64TEX",o._innerBufferLoaderManager=new t.LoaderManager,o._innerTextureLoaderManager=new t.LoaderManager,e.glTFBase64Tool=r,e.glTFLoader=o,e.glTFTextureEditor=a,e.glTFUtils=s}(window.Laya=window.Laya||{},Laya);